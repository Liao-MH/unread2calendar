<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Settings</title>
  <style>
    :root {
      --e2c-base-font-size: 14px;
      --e2c-text-color: var(--in-content-page-color, #1f2937);
      --e2c-module-bg: var(--in-content-page-background, #f8fafc);
      --e2c-card-bg: var(--in-content-box-background, #ffffff);
      --e2c-card-border: var(--in-content-box-border-color, #d8dee7);
      --e2c-button-bg: #146ef5;
      --e2c-button-text: #ffffff;
      --e2c-group-title-color: #111827;
      --e2c-item-title-color: #111827;
      --e2c-meta-color: #4b5565;
      --e2c-status-color: #4b5565;
      --e2c-group-gap: 14px;
      --e2c-card-gap: 8px;
      --e2c-card-radius: 10px;
      --e2c-title-weight: 700;
      --e2c-group-title-size: 16px;
      --e2c-item-title-size: 14px;
      --e2c-meta-size: 12px;
      --e2c-status-size: 11px;
      --e2c-card-padding-y: 12px;
      --e2c-card-padding-x: 12px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 20px; font-size: var(--e2c-base-font-size); color: var(--e2c-text-color); background: var(--e2c-module-bg); }
    .section { border: 1px solid var(--e2c-card-border); border-radius: var(--e2c-card-radius); padding: var(--e2c-card-padding-y) var(--e2c-card-padding-x); margin-bottom: var(--e2c-group-gap); background: var(--e2c-card-bg); box-shadow: var(--e2c-card-shadow, none); }
    .section h2 { margin: 0 0 10px; font-size: var(--e2c-group-title-size); color: var(--e2c-group-title-color); }
    .row { display: grid; gap: 6px; margin-bottom: 12px; }
    .toggle-row { display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 10px; }
    .chips { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .chip { display: inline-flex; align-items: center; gap: 6px; border: 1px solid var(--e2c-card-border); border-radius: 999px; padding: 4px 8px; background: var(--e2c-card-bg); }
    .chip button { border: none; background: transparent; color: #b91c1c; cursor: pointer; padding: 0; }
    .chip.chip-draggable { cursor: grab; user-select: none; }
    .chip.chip-draggable.dragging { opacity: 0.6; }
    .chip-handle { color: #6b7280; font-weight: 700; font-size: 12px; line-height: 1; }
    .chip-input-row { display: flex; gap: 8px; margin-top: 6px; }
    .chip-input-row input { flex: 1; }
    label { font-weight: 600; color: var(--e2c-item-title-color); }
    input, select, textarea { padding: 8px; border: 1px solid var(--e2c-card-border); border-radius: 8px; background: #fff; color: var(--e2c-text-color); }
    input[type="checkbox"] { width: 16px; height: 16px; margin: 0; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--e2c-button-bg); background: var(--e2c-button-bg); color: var(--e2c-button-text); cursor: pointer; }
    .minor-btn { border-color: var(--e2c-card-border); background: #fff; color: var(--e2c-text-color); }
    #status, .section-status { margin-top: 12px; border: 1px solid var(--e2c-card-border); border-radius: 8px; padding: 8px; min-height: 20px; white-space: pre-wrap; color: var(--e2c-status-color); font-size: var(--e2c-status-size); }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; }
    .cols-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .appearance-advanced[hidden] { display: none; }
    .help-text { margin-top: 2px; font-size: 11px; color: #6b7280; }
    .subsection { border: 1px solid var(--e2c-card-border); border-radius: 10px; padding: 10px; margin-bottom: 10px; background: rgba(255,255,255,0.6); }
    .subsection h3 { margin: 0 0 8px; font-size: 14px; color: var(--e2c-group-title-color); }
    .subsection-desc { margin: 0 0 10px; color: var(--e2c-meta-color); font-size: 12px; }
    .settings-layout { display: grid; grid-template-columns: 220px minmax(0, 1fr); gap: 14px; align-items: start; }
    .settings-nav { position: sticky; top: 10px; border: 1px solid var(--e2c-card-border); border-radius: 10px; background: var(--e2c-card-bg); padding: 8px; display: grid; gap: 8px; }
    .settings-nav button { border-color: var(--e2c-card-border); background: #fff; color: var(--e2c-text-color); text-align: left; }
    .settings-nav button.active { border-color: var(--e2c-button-bg); background: color-mix(in srgb, var(--e2c-button-bg) 12%, #fff); }
    .settings-page[hidden] { display: none; }
    .legacy-hidden { display: none; }
    .settings-page-save { margin: -4px 0 14px; }
    .appearance-layout { display: grid; grid-template-columns: minmax(0, 1fr) 380px; gap: 12px; align-items: start; }
    .appearance-main { min-width: 0; }
    .appearance-preview { position: sticky; top: 10px; border: 1px solid var(--e2c-card-border); border-radius: 12px; padding: 10px; background: var(--e2c-card-bg); box-shadow: 0 0 0 1px color-mix(in srgb, var(--e2c-card-border) 75%, transparent), 0 6px 18px rgba(17,24,39,0.08); }
    .preview-title { margin: 0 0 8px; font-size: 13px; color: var(--e2c-group-title-color); }
    .preview-frame { border: 2px solid var(--e2c-card-border); border-radius: calc(var(--e2c-card-radius) + 4px); background: var(--e2c-module-bg); padding: 10px; display: grid; gap: var(--e2c-group-gap); aspect-ratio: 2 / 3; min-height: 520px; overflow: auto; }
    .preview-toolbar { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .preview-toolbar button { font-size: 12px; padding: 6px 8px; }
    .preview-group { border: 1px solid var(--e2c-card-border); border-radius: var(--e2c-card-radius); background: var(--e2c-card-bg); }
    .preview-group-head { padding: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; color: var(--e2c-group-title-color); font-weight: 700; border-bottom: 1px solid var(--e2c-card-border); }
    .preview-items { display: grid; gap: var(--e2c-event-gap); padding: 8px; }
    .preview-item { border: 1px solid var(--e2c-card-border); border-radius: var(--e2c-card-radius); background: var(--e2c-card-bg); padding: var(--e2c-card-padding-y) var(--e2c-card-padding-x); cursor: pointer; min-height: var(--e2c-card-min-height); box-shadow: var(--e2c-card-shadow); display: grid; gap: var(--e2c-card-gap); }
    .preview-item-title { font-size: var(--e2c-item-title-size); font-weight: var(--e2c-title-weight); color: var(--e2c-item-title-color); }
    .preview-item-meta { margin-top: 0; font-size: var(--e2c-meta-size); color: var(--e2c-meta-color); }
    .preview-item.is-collapsed .preview-item-meta { display: none; }
    .preview-item-actions { display: flex; gap: var(--e2c-action-gap); margin-top: 0; }
    .preview-item-actions button { font-size: 11px; padding: 4px 6px; border-radius: 6px; }
    .preview-footer { border: 1px solid var(--e2c-card-border); border-radius: 8px; padding: 6px 8px; color: var(--e2c-status-color); font-size: var(--e2c-status-size); background: var(--e2c-card-bg); }
    @media (max-width: 1100px) {
      .appearance-layout { grid-template-columns: 1fr; }
      .appearance-preview { position: static; }
    }
  </style>
</head>
<body>
  <h1 id="pageTitle">配置（Settings）</h1>
  <div class="settings-layout">
    <aside id="settingsNav" class="settings-nav">
      <button type="button" data-page="general" class="active">常规</button>
      <button type="button" data-page="llm">LLM</button>
      <button type="button" data-page="rules">本地规则</button>
      <button type="button" data-page="appearance">外观</button>
      <button type="button" data-page="io">导入导出</button>
    </aside>
    <main id="settingsPages">

  <section class="section settings-page" data-page="general">
    <h2>常规</h2>
    <div class="row">
      <label for="debugMode">调试模式（显示当前邮件上下文）</label>
      <div class="toggle-row">
        <input id="debugMode" type="checkbox">
        <span id="debugModeHelp">仅用于排查，默认关闭</span>
      </div>
    </div>
    <div id="generalStatus" class="section-status"></div>
  </section>
  <div class="toolbar settings-page settings-page-save" data-page="general">
    <button id="saveGeneralBtn" type="button">保存本页</button>
  </div>

  <section class="section settings-page" data-page="llm" hidden>
    <h2 id="llmSectionTitle">LLM 配置（LLM Settings）</h2>
    <div class="row cols-2">
      <div class="row">
        <label id="providerLabel" for="llmProvider">供应商预设（Provider）</label>
        <select id="llmProvider"></select>
      </div>
      <div class="row">
        <label id="modelPresetLabel" for="llmModelPreset">模型预设（Model Preset）</label>
        <select id="llmModelPreset"></select>
      </div>
    </div>
    <div class="toolbar">
      <button id="refreshPresetsBtn" type="button" class="minor-btn">更新供应商与模型预设</button>
    </div>
    <div class="row">
      <label id="baseUrlLabel" for="baseUrl">Base URL</label>
      <input id="baseUrl" placeholder="https://api.openai.com/v1">
    </div>
    <div class="row">
      <label id="modelLabel" for="model">Model</label>
      <input id="model" placeholder="gpt-4.1-mini">
    </div>
    <div class="row">
      <label id="apiKeyLabel" for="apiKey">API Key</label>
      <input id="apiKey" type="password" placeholder="云端模型填写，本地模型可留空">
    </div>
    <div class="row">
      <label id="temperatureLabel" for="temperature">温度（Temperature）</label>
      <div class="toggle-row">
        <input id="useTemperature" type="checkbox">
        <input id="temperature" type="number" step="0.1" min="0" max="2" value="0.1">
      </div>
    </div>
    <div class="row">
      <label id="maxTokensLabel" for="maxTokens">最大令牌数（Max Tokens）</label>
      <div class="toggle-row">
        <input id="useMaxTokens" type="checkbox">
        <input id="maxTokens" type="number" step="1" min="1" value="1024">
      </div>
    </div>
    <div class="row">
      <label id="topPLabel" for="topP">核采样（Top P）</label>
      <div class="toggle-row">
        <input id="useTopP" type="checkbox">
        <input id="topP" type="number" step="0.1" min="0" max="1" value="1">
      </div>
    </div>
    <div class="toolbar">
      <button id="testBtn" type="button">测试连接</button>
    </div>
    <div id="status"></div>
  </section>

  <section class="section settings-page" data-page="llm" hidden>
    <h2 id="promptSectionTitle">自定义 LLM Prompt</h2>
    <div class="row">
      <label id="promptLabel" for="llmPromptTemplate">Prompt 模板</label>
      <textarea id="llmPromptTemplate" rows="10" style="padding:8px;border:1px solid #c4c9d4;border-radius:8px;font-family:ui-monospace,SFMono-Regular,Menlo,monospace;"></textarea>
      <small id="promptHelp">可用变量：{{uiLanguage}} {{defaultTimeZone}} {{allowedGroupsJson}} {{messageJson}} {{bodyText}}</small>
    </div>
    <div class="toolbar">
      <button id="resetPromptBtn" type="button" class="minor-btn">恢复默认Prompt</button>
    </div>
  </section>

  <section class="section settings-page" data-page="llm" hidden>
    <h2 id="groupConstraintTitle">LLM 分组约束（Groups）</h2>
    <div class="row">
      <label id="llmGroupsLabel">可用分组名称（每封邮件仅归入一个）</label>
      <div id="llmGroupsChips" class="chips"></div>
      <div class="chip-input-row">
        <input id="llmGroupsInput" placeholder="输入分组名称后回车，例如 学术活动">
      </div>
      <small id="llmGroupsSortHint" class="help-text">可拖动排序，排序将同步用于 LLM 分组约束、本地规则分组和外观固定分组配色顺序。</small>
    </div>
  </section>

  <section class="section settings-page" data-page="llm" hidden>
    <h2 id="processingTitle">识别运行参数（Processing）</h2>
    <div class="row">
      <label for="llmBodyMaxChars">单封正文最大字符数</label>
      <input id="llmBodyMaxChars" type="number" min="1000" step="500" value="12000">
    </div>
    <div class="row">
      <label for="llmBatchSize">每批邮件数量</label>
      <input id="llmBatchSize" type="number" min="1" step="1" value="20">
    </div>
    <div class="row">
      <label for="llmRetryCount">失败重试次数</label>
      <input id="llmRetryCount" type="number" min="0" step="1" value="1">
    </div>
    <div class="row">
      <label for="llmBatchDelayMs">批间隔（毫秒）</label>
      <input id="llmBatchDelayMs" type="number" min="0" step="50" value="100">
    </div>
  </section>
  <div class="toolbar settings-page settings-page-save" data-page="llm" hidden>
    <button id="saveLlmPageBtn" type="button">保存本页</button>
  </div>

  <section class="section settings-page" data-page="rules" hidden>
    <h2 id="localRuleSectionTitle">本地规则关键词（Local Rule Keywords）</h2>

    <div class="row">
      <label id="timeKeywordsLabel">时间关键词（Time Keywords）</label>
      <div id="timeKeywordsChips" class="chips"></div>
      <div class="chip-input-row">
        <input id="timeKeywordsInput" placeholder="输入关键词后回车">
      </div>
    </div>

    <div class="row">
      <label id="locationKeywordsLabel">地点关键词（Location Keywords）</label>
      <div id="locationKeywordsChips" class="chips"></div>
      <div class="chip-input-row">
        <input id="locationKeywordsInput" placeholder="输入关键词后回车，例如 Venue">
      </div>
    </div>

    <div id="dynamicGroupKeywordRows"></div>
    <div class="legacy-hidden">
      <div id="groupAcademicChips" class="chips"></div><input id="groupAcademicInput">
      <div id="groupCourseChips" class="chips"></div><input id="groupCourseInput">
      <div id="groupActivityChips" class="chips"></div><input id="groupActivityInput">
      <div id="groupImportantChips" class="chips"></div><input id="groupImportantInput">
      <div id="groupOtherChips" class="chips"></div><input id="groupOtherInput">
      <label id="groupAcademicLabel"></label><label id="groupCourseLabel"></label><label id="groupActivityLabel"></label><label id="groupImportantLabel"></label><label id="groupOtherLabel"></label>
    </div>

    <div class="toolbar">
      <button id="resetRulesBtn" type="button" class="minor-btn">重置默认关键词</button>
    </div>
  </section>
  <div class="toolbar settings-page settings-page-save" data-page="rules" hidden>
    <button id="saveRulesPageBtn" type="button">保存本页</button>
  </div>

  <section class="section settings-page" data-page="appearance" hidden>
    <h2 id="appearanceSectionTitle">外观配置（Appearance）</h2>
    <div class="appearance-layout">
      <div class="appearance-main">
        <div class="toolbar">
          <button id="appearanceResetAllTopBtn" type="button" class="minor-btn">全部恢复默认</button>
        </div>

        <div id="appearanceTopModule" class="subsection">
      <h3>顶部区域</h3>
      <p class="subsection-desc">页面级视觉样式：主题模式、基础字体、按钮、模块背景。</p>
      <div class="row cols-2">
        <div class="row">
          <label for="appearanceMode">模式（Mode）</label>
          <select id="appearanceMode">
            <option value="follow_tb">跟随 Thunderbird（默认）</option>
            <option value="preset">使用预设主题</option>
            <option value="custom">完全自定义</option>
          </select>
        </div>
        <div class="row">
          <label for="appearancePreset">预设主题（Preset）</label>
          <select id="appearancePreset">
            <option value="system">跟随系统</option>
            <option value="contrast_light">高对比浅色</option>
            <option value="contrast_dark">高对比深色</option>
            <option value="soft_eye">护眼柔和</option>
            <option value="academic_bluegray">学术蓝灰</option>
            <option value="vibrant_orangegreen">活力橙绿</option>
          </select>
        </div>
      </div>
      <div class="row cols-2">
        <div class="row">
          <label for="appearanceTextColor">主字体颜色</label>
          <input id="appearanceTextColor" type="color" value="#141824">
        </div>
        <div class="row">
          <label for="appearanceBaseFontSize">基础字号（px）</label>
          <input id="appearanceBaseFontSize" type="number" min="10" max="24" step="1" value="14">
        </div>
        <div class="row">
          <label for="appearanceTitleBold">标题粗体</label>
          <div class="toggle-row">
            <input id="appearanceTitleBold" type="checkbox" checked>
            <span>启用粗体标题</span>
          </div>
        </div>
        <div class="row">
          <label for="appearanceModuleBg">模块背景色</label>
          <input id="appearanceModuleBg" type="color" value="#ffffff">
        </div>
        <div class="row">
          <label for="appearanceButtonBg">按钮背景色</label>
          <input id="appearanceButtonBg" type="color" value="#146ef5">
        </div>
        <div class="row">
          <label for="appearanceButtonText">按钮文字色</label>
          <input id="appearanceButtonText" type="color" value="#ffffff">
        </div>
      </div>
      <div class="toolbar">
        <button id="appearanceResetTopModuleBtn" type="button" class="minor-btn">恢复本模块默认</button>
      </div>
    </div>

        <div id="appearanceMiddleModule" class="subsection">
      <h3>中部事件区</h3>
      <p class="subsection-desc">分组和事件卡片样式：文字、间距、圆角、边框与分组配色。</p>
      <div class="row cols-2">
        <div class="row"><label for="appearanceGroupTitleColor">分组标题颜色</label><input id="appearanceGroupTitleColor" type="color" value="#111827"></div>
        <div class="row"><label for="appearanceGroupTitleSize">分组标题字号</label><input id="appearanceGroupTitleSize" type="number" min="10" max="24" step="1" value="14"></div>
        <div class="row"><label for="appearanceItemTitleColor">事件标题颜色</label><input id="appearanceItemTitleColor" type="color" value="#111827"></div>
        <div class="row"><label for="appearanceItemTitleSize">事件标题字号</label><input id="appearanceItemTitleSize" type="number" min="10" max="22" step="1" value="13"></div>
        <div class="row"><label for="appearanceMetaColor">时间地点颜色</label><input id="appearanceMetaColor" type="color" value="#4b5565"></div>
        <div class="row"><label for="appearanceMetaSize">时间地点字号</label><input id="appearanceMetaSize" type="number" min="9" max="20" step="1" value="12"></div>
        <div class="row"><label for="appearanceCardBg">卡片背景色</label><input id="appearanceCardBg" type="color" value="#ffffff"></div>
        <div class="row"><label for="appearanceCardBorderColor">卡片边框色</label><input id="appearanceCardBorderColor" type="color" value="#d8dee7"></div>
        <div class="row"><label for="appearanceCardRadius">卡片圆角（px）</label><input id="appearanceCardRadius" type="number" min="0" max="24" step="1" value="10"></div>
        <div class="row"><label for="appearanceCardShadow">卡片阴影强度（px）</label><input id="appearanceCardShadow" type="number" min="0" max="24" step="1" value="0"></div>
        <div class="row"><label for="appearanceCardMinHeight">卡片高度（最小 px）</label><input id="appearanceCardMinHeight" type="number" min="0" max="300" step="1" value="0"></div>
        <div class="row"><label for="appearanceCardGap">卡片内元素间距（px）</label><input id="appearanceCardGap" type="number" min="0" max="36" step="1" value="8"></div>
        <div class="row"><label for="appearanceCardPaddingY">卡片内边距Y（px）</label><input id="appearanceCardPaddingY" type="number" min="0" max="36" step="1" value="8"></div>
        <div class="row"><label for="appearanceCardPaddingX">卡片内边距X（px）</label><input id="appearanceCardPaddingX" type="number" min="0" max="36" step="1" value="8"></div>
        <div class="row"><label for="appearanceEventGap">事件卡片间距（px）</label><input id="appearanceEventGap" type="number" min="0" max="36" step="1" value="8"></div>
        <div class="row"><label for="appearanceActionGap">事件按钮间距（px）</label><input id="appearanceActionGap" type="number" min="0" max="36" step="1" value="8"></div>
        <div class="row"><label for="appearanceGroupGap">模块间距（px）</label><input id="appearanceGroupGap" type="number" min="0" max="32" step="1" value="10"></div>
      </div>

      <div class="row">
        <label>固定分组配色（边框+确认按钮）</label>
      </div>
      <div id="dynamicAppearanceGroupRows" class="row cols-2"></div>
      <div class="legacy-hidden">
        <input id="appearanceGroupAccentImportant" type="color" value="#d97706"><input id="appearanceGroupBgImportant" type="color" value="#ffffff">
        <input id="appearanceGroupAccentAcademic" type="color" value="#2563eb"><input id="appearanceGroupBgAcademic" type="color" value="#ffffff">
        <input id="appearanceGroupAccentCourse" type="color" value="#0891b2"><input id="appearanceGroupBgCourse" type="color" value="#ffffff">
        <input id="appearanceGroupAccentActivity" type="color" value="#16a34a"><input id="appearanceGroupBgActivity" type="color" value="#ffffff">
        <input id="appearanceGroupAccentOther" type="color" value="#6b7280"><input id="appearanceGroupBgOther" type="color" value="#ffffff">
        <input id="appearanceGroupAccentUnrecognized" type="color" value="#7c3aed"><input id="appearanceGroupBgUnrecognized" type="color" value="#ffffff">
      </div>
      <div class="toolbar">
        <button id="appearanceResetMiddleModuleBtn" type="button" class="minor-btn">恢复本模块默认</button>
      </div>
    </div>

        <div id="appearanceBottomModule" class="subsection">
      <h3>底部固定区</h3>
      <p class="subsection-desc">状态栏展示样式。</p>
      <div class="row cols-2">
        <div class="row"><label for="appearanceStatusColor">状态栏颜色</label><input id="appearanceStatusColor" type="color" value="#4b5565"></div>
        <div class="row"><label for="appearanceStatusSize">状态栏字号</label><input id="appearanceStatusSize" type="number" min="9" max="20" step="1" value="11"></div>
      </div>
      <div class="toolbar">
        <button id="appearanceResetBottomModuleBtn" type="button" class="minor-btn">恢复本模块默认</button>
      </div>
    </div>

        <div class="toolbar">
          <button id="appearanceResetAllBottomBtn" type="button" class="minor-btn">全部恢复默认</button>
        </div>
      </div>
      <aside id="appearancePreviewPanel" class="appearance-preview">
        <h3 id="appearancePreviewTitle" class="preview-title">主窗口预览（可交互）</h3>
        <div id="appearancePreviewRoot" class="preview-frame"></div>
      </aside>
    </div>
    <div id="appearanceStatus" class="section-status"></div>
  </section>
  <div class="toolbar settings-page settings-page-save" data-page="appearance" hidden>
    <button id="saveAppearanceBtn" type="button">保存本页</button>
  </div>

  <section class="section settings-page" data-page="io" hidden>
    <h2>导入导出</h2>
    <div class="toolbar">
      <button id="exportSettingsBtn" type="button" class="minor-btn">导出配置(JSON)</button>
      <button id="importSettingsBtn" type="button" class="minor-btn">导入配置(JSON)</button>
      <input id="importSettingsFile" type="file" accept="application/json" hidden>
    </div>
    <div id="ioStatus" class="section-status"></div>
  </section>

    </main>
  </div>
  <script src="../common/appearance.js"></script>
  <script src="options.js"></script>
</body>
</html>
