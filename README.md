# Unread2Calendar Todo Sidebar

[中文](./README.md) | [English](./README.en.md)

> Thunderbird 邮件待办识别与日历导入插件。支持 LLM 识别（云端/本地）与本地规则识别，提供可视化审核后再导入日历。

## 目录
- [插件简介](#插件简介)
- [核心能力](#核心能力)
- [安装指南](#安装指南)
- [30 秒快速开始](#30-秒快速开始)
- [详细使用说明](#详细使用说明)
- [配置说明](#配置说明)
- [常见问题（速查）](#常见问题速查)
- [隐私与数据说明](#隐私与数据说明)
- [项目结构（用户关心）](#项目结构用户关心)
- [版本与更新](#版本与更新)

## 插件简介
`Unread2Calendar Todo Sidebar` 用于从邮件中识别潜在待办/活动事件，并在你确认后导入 Thunderbird 日历。

典型场景：
- 扫描未读邮件，自动抽取讲座、课程、活动、报名提醒等。
- 将“可能重要但不一定是活动”的邮件单独归组处理。
- 对每条识别结果执行“确认/拒绝/标记已读/转为待办”等决策。
- 最终批量导入到指定日历，并保留近 30 天导入记录。

## 核心能力
- 识别入口：
  - `扫描未读`（支持选择账号，范围为 Inbox + 子文件夹）
  - `刷新`（清空后仅识别当前邮件）
  - 右键菜单 `识别待办事项`（支持多选邮件）
- 识别引擎：
  - 已配置 LLM：优先使用 LLM。
  - 未配置 LLM：自动回退本地规则。
- LLM 支持：
  - 云端 OpenAI 兼容接口。
  - 本地模型：OpenAI 兼容端点 + Ollama 原生接口。
- 分组与展示：
  - 固定首组：`可能重要的事`
  - 固定末组：`未识别到待办`
  - 固定底部区域：`已添加日历`（默认折叠）
  - 常规分组由 LLM 分组约束与识别结果共同决定。
- 任务控制：`暂停 / 继续 / 取消任务`
- 日历导入：
  - 导入前选择目标日历
  - 导入后跳转日历视图
  - 记录导入历史用于核验
- 配置中心：
  - LLM、Prompt、分组、本地规则、外观、导入导出
  - 中英文界面文案随 Thunderbird 语言切换

## 安装指南
### 1) 准备 XPI
当前仓库打包产物目录：`dist/`

例如当前版本：
- `dist/unread2calendar-thunderbird-2.0.2.xpi`
- 最新 Release 直链下载：
  - `https://github.com/Liao-MH/unread2calendar/releases/download/v2.0.2/unread2calendar-thunderbird-2.0.2.xpi`

### 2) 在 Thunderbird 安装
1. 打开 Thunderbird。
2. 进入 `附加组件和主题` 页面。
3. 点击右上角齿轮菜单，选择“从文件安装附加组件”。
4. 选择 `.xpi` 文件并安装。
5. 安装完成后重启 Thunderbird（建议）。

### 3) 确认按钮可见
安装后你应该在工具栏或邮件阅读相关入口看到 `Todo Sidebar` 按钮。

如果没看到：
- 先确认插件在附加组件页面已启用。
- 在工具栏自定义里把 `Todo Sidebar` 拖入可见区域。
- 若按钮为菜单样式，点开下拉菜单选择“识别待办事项”。

## 30 秒快速开始
1. 点击 `扫描未读`。
2. 在账号弹窗里勾选要扫描的邮箱，点 `开始扫描`。
3. 查看状态栏（底部）进度：例如“状态：上传 x/y 封邮件”。
4. 在中间分组区单击事件：
   - 打开对应邮件
   - 展开标题/时间/地点详情
5. 对事件做决策（确认/拒绝/标记已读/转为待办）。
6. 点击 `导入日历`，选择目标日历并确认。
7. 到 `已添加日历` 分组核验导入记录。

## 详细使用说明
### 一、主窗口区域
- 顶部固定操作区：`扫描未读`、`刷新`、`全部展开/收起`、`配置`、`清屏`
- 顶部任务控制区：`暂停`、`继续`、`取消任务`
- 中部滚动区：待办分组和事件卡片
- 底部固定区：`导入日历`、`已添加日历`、状态栏、版本号

### 二、三个识别入口的区别
- `扫描未读`：
  - 面向批量场景
  - 会先弹账号选择
  - 扫描 Inbox + 子文件夹
- `刷新`：
  - 面向当前单封邮件
  - 会先清空现有待办，再识别当前邮件
- 右键 `识别待办事项`：
  - 面向你手动选中的邮件
  - 会先清空现有待办，再识别所选邮件并自动打开主窗口

### 三、事件交互逻辑
- 单击事件：
  - 选中并打开对应邮件正文
  - 展开/收起该事件详情（标题、时间、地点）
- 双击事件：
  - 进入就地编辑（直接在卡片位置编辑）
- 决策按钮：
  - 待办事件：`确认` / `拒绝` / `恢复`
  - 可能重要事件：`转为待办` / `标记已读`
- 事件处理后：
  - 会更新状态和显示样式
  - “已添加日历”用于记录已导入结果

### 四、分组说明
- `可能重要的事`：固定第一组。
- 常规分组：由配置中的可用分组 + 识别结果生成。
- `未识别到待办`：固定最后一组，显示未提取到可执行待办的邮件摘要。
- `已添加日历`：底部固定区，默认折叠，显示近 30 天导入记录。

### 五、任务控制说明
- `暂停`：暂停识别流程，保留当前进度和已识别结果。
- `继续`：从暂停点继续。
- `取消任务`：终止当前识别任务，不再继续上传与识别。
- `清屏`：清空当前待办显示与状态文本（便于开始新一轮识别）。

## 配置说明
点击主窗口 `配置` 进入设置页。设置页为左侧导航分页结构：

### 1) 常规
- 调试模式开关（用于排查问题时显示更多上下文）

### 2) LLM
- 供应商预设 + 模型预设
- 支持“更新供应商与模型预设”
- 支持参数开关：
  - Temperature
  - Max Tokens
  - Top P
  - 未勾选则不发送该参数
- 连接测试：显示成功结果或完整错误信息

本地模型说明：
- `本地模型（OpenAI兼容）`：适用于 LM Studio / vLLM 等本地 OpenAI 兼容服务
- `本地模型（Ollama）`：适用于 Ollama 本地服务
- 本地模型可不填 API Key

### 3) Prompt
- 可自定义 LLM Prompt 模板
- 支持恢复默认 Prompt

### 4) 分组约束
- 可配置“可用分组名称”
- 支持拖动排序
- 同步影响：LLM 分组约束 / 本地规则分组 / 外观固定分组顺序

### 5) 本地规则
- 可维护时间关键词、地点关键词、各分组关键词
- 关键词匹配忽略大小写
- LLM 返回的分类关键词可自动回写并去重

### 6) 外观
- 支持基础外观 + 更多外观配置
- 支持按组设置边框/按钮主色与可选背景色
- 支持预览
- 每个模块可恢复默认

### 7) 导入导出
- 导出配置（JSON）
- 导入配置（JSON）
- 操作后有成功/失败提示

## 常见问题（速查）
1. 看不到 `Todo Sidebar` 按钮怎么办？
- 检查插件是否启用；在工具栏自定义里手动加入按钮；检查按钮是否被折叠到下拉菜单。

2. 主窗口提示“LLM 未配置，正在使用本地规则”是什么意思？
- 说明当前 LLM 配置不可用，系统自动走本地规则识别。

3. 已填 LLM，但提示“LLM测试连接失败”怎么办？
- 在配置页点 `测试连接`，查看完整错误（状态码/响应体/日志）。

4. OpenAI 报 `Unsupported parameter: messages` 怎么办？
- 这是接口协议不匹配导致；当前版本已兼容 Responses 与 Chat Completions，建议先点“更新供应商与模型预设”并重测。

5. 本地模型要不要 API Key？
- 通常不需要；云端模型一般需要。

6. 点击 `刷新` 没结果怎么办？
- `刷新`只识别当前活动邮件。请先在 Thunderbird 里选中一封邮件再点刷新。

7. 扫描很多邮件时感觉慢怎么办？
- 可在配置页调小 `单封正文最大字符数`、`每批邮件数量`，必要时使用 `暂停/继续` 分段处理。

8. 导入日历时报“未读取到可写日历”怎么办？
- 检查 Thunderbird 日历是否已创建且可写；确认插件有日历读写权限。

9. 导入成功但日历里没看到事件怎么办？
- 先确认选择了正确日历；再查看 `已添加日历` 分组记录，并切换到对应日期/时间段核对。

10. 为什么显示时间和导入后时间看起来不同？
- 主窗口可能显示原始事件时区；导入日历会按本地时区落地显示。

11. 为什么“未识别到待办”里有邮件？
- 表示邮件经识别后未发现明确可执行待办，系统会保留一句话摘要供你复查。

12. 事件点开后能编辑吗？
- 可以，双击事件进入就地编辑。

13. 识别中处理过的灰态为什么又变化了？
- 若任务仍在持续返回新结果，界面会刷新；建议先暂停任务再集中处理。

14. 配置保存后是否有提示？
- 有，保存/导入/导出都会有成功或失败提示。

15. 界面语言怎么切换？
- 跟随 Thunderbird 当前语言（中文/英文）。

## 隐私与数据说明
- 插件本地保存：
  - 识别结果、配置项、导入记录（近 30 天）
- 仅在使用 LLM 时，插件会把用于识别的邮件文本内容发送到你配置的模型服务。
- 你可选择仅使用本地规则，避免向外部模型发送邮件文本。
- 本地模型模式下，数据可仅在本机回路处理（取决于你的本地模型服务设置）。

## 项目结构（用户关心）
- 插件主体：`thunderbird-addon/`
- 打包产物：`dist/`
- 构建脚本：`scripts/build_thunderbird_xpi.sh`
- 开发日志：`docs/CHANGELOG.md`

## 版本与更新
- 当前文档对应插件版本：`v2.0.2`
- 历史改动与每版说明：见 [docs/CHANGELOG.md](./docs/CHANGELOG.md)

---
如果你是第一次使用，建议先按“30 秒快速开始”跑一遍，再进入配置页微调识别与外观。
